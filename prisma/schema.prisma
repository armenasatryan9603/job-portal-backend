generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ResourceBookingMode {
  select        // Client selects resource
  auto          // System assigns automatically
  multi         // Requires multiple resources
}

model User {
  id                       Int                       @id @default(autoincrement())
  role                     String
  name                     String
  email                    String?                   @unique
  phone                    String?                   @unique
  passwordHash             String
  avatarUrl                String?
  bannerUrl                String?
  bio                      String?
  creditBalance            Float                     @default(0)
  verified                 Boolean                   @default(false)
  otpCode                  String?
  otpExpiresAt             DateTime?
  createdAt                DateTime                  @default(now())
  experienceYears          Int?
  priceMin                 Float?
  priceMax                 Float?
  location                 String?
  currency                 String?
  rateUnit                 String?
  fcmToken                 String?
  referralCode             String?                   @unique
  referralCredits          Float                     @default(0)
  referredBy               Int?
  preferences              Json?
  languages                Json?
  Cards                    Card[]
  ConversationParticipants ConversationParticipant[]
  CreditTransactions       CreditTransaction[]
  MediaFiles               MediaFile[]               @relation("MediaUploader")
  SentMessages             Message[]                 @relation("MessageSender")
  Notifications            Notification[]
  Orders                   Order[]                   @relation("ClientOrders")
  Proposals                OrderProposal[]
  referredRewards          ReferralReward[]          @relation("ReferredUser")
  referralRewards          ReferralReward[]          @relation("ReferralRewards")
  Reviews                  Review[]                  @relation("Reviewer")
  SpecialistReviews        Review[]                  @relation("Specialist")
  referrer                 User?                     @relation("UserReferrals", fields: [referredBy], references: [id])
  referrals                User[]                    @relation("UserReferrals")
  UserCategories           UserCategory[]
  OrderChangeHistory       OrderChangeHistory[]      @relation("OrderChangedBy")
  SavedOrders              SavedOrder[]              @relation("SavedOrders")
  Portfolio                Portfolio[]               @relation("Portfolio")
  PeerRelationships        PeerRelationship[]        @relation("PeerRelationships")
  PeerOf                   PeerRelationship[]        @relation("PeerOf")
  TeamMembers              TeamMember[]
  CreatedTeams             Team[]                    @relation("TeamCreator")
  ProposalPeers            ProposalPeer[]
  LeadProposals            OrderProposal[]           @relation("LeadProposals")
  Subscriptions            UserSubscription[]
  SubscriptionTransactions SubscriptionTransaction[]
  Bookings                 Booking[]                 @relation("ClientBookings")
  MarketMembers            MarketMember[]
  CreatedMarkets           Market[]                  @relation("MarketCreator")
  MarketReviews            MarketReview[]
  MarketMediaFiles         MarketMediaFile[]         @relation("MarketMediaUploader")
  MarketSubscriptions      MarketSubscription[]
  deletedAt                DateTime?

  @@index([deletedAt])
}

model Category {
  id                   Int                  @id @default(autoincrement())
  name                 String
  description          String?
  nameEn               String?
  nameRu               String?
  nameHy               String?
  descriptionEn        String?
  descriptionRu        String?
  descriptionHy        String?
  parentId             Int?
  averagePrice         Float?
  minPrice             Float?
  maxPrice             Float?
  currency             String?
  rateUnit             String?
  completionRate       Float?               @default(0)
  isActive             Boolean              @default(true)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  imageUrl             String?
  Orders               Order[]
  Parent               Category?            @relation("CategoryChildren", fields: [parentId], references: [id])
  Children             Category[]           @relation("CategoryChildren")
  CategoryFeatures     CategoryFeature[]
  CategoryTechnologies CategoryTechnology[]
  UserCategories       UserCategory[]

  @@index([parentId])
  @@index([isActive])
}

model Feature {
  id               Int               @id @default(autoincrement())
  name             String            @unique
  nameEn           String?
  nameRu           String?
  nameHy           String?
  description      String?
  descriptionEn    String?
  descriptionRu    String?
  descriptionHy    String?
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  CategoryFeatures CategoryFeature[]

  @@index([isActive])
}

model Technology {
  id                   Int                  @id @default(autoincrement())
  name                 String               @unique
  nameEn               String?
  nameRu               String?
  nameHy               String?
  description          String?
  descriptionEn        String?
  descriptionRu        String?
  descriptionHy        String?
  isActive             Boolean              @default(true)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  CategoryTechnologies CategoryTechnology[]

  @@index([isActive])
}

model CategoryFeature {
  id         Int      @id @default(autoincrement())
  categoryId Int
  featureId  Int
  createdAt  DateTime @default(now())
  Feature    Feature  @relation(fields: [featureId], references: [id], onDelete: Cascade)
  Category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, featureId])
  @@index([categoryId])
  @@index([featureId])
}

model CategoryTechnology {
  id           Int        @id @default(autoincrement())
  categoryId   Int
  technologyId Int
  createdAt    DateTime   @default(now())
  Category     Category   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  Technology   Technology @relation(fields: [technologyId], references: [id], onDelete: Cascade)

  @@unique([categoryId, technologyId])
  @@index([categoryId])
  @@index([technologyId])
}

model UserCategory {
  id                   Int      @id @default(autoincrement())
  userId               Int
  categoryId           Int
  notificationsEnabled Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  Category             Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  User                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@index([userId])
  @@index([categoryId])
}

model Order {
  id                      Int                  @id @default(autoincrement())
  clientId                Int
  categoryId              Int?
  title                   String?
  description             String?
  budget                  Float?
  currency                String               @default("AMD")
  rateUnit                String               @default("per_project")
  availableDates          String[]             @default([])
  location                String?
  status                  String               @default("open")
  createdAt               DateTime             @default(now())
  bannerImageId           Int?
  titleEn                 String?
  titleRu                 String?
  titleHy                 String?
  descriptionEn           String?
  descriptionRu           String?
  descriptionHy           String?
  rejectionReason         String?
  orderType               String               @default("one_time") // "one_time" or "permanent"
  workDurationPerClient   Int? // Duration in minutes for each appointment
  weeklySchedule          Json? // Recurring weekly schedule for permanent orders
  checkinRequiresApproval Boolean              @default(false) // If true, bookings require owner approval
  resourceBookingMode     ResourceBookingMode? // How clients book resources
  requiredResourceCount   Int? // Number of resources required per booking session (for multi mode)
  Conversations           Conversation[]
  MediaFiles              MediaFile[]
  BannerImage             MediaFile?           @relation("BannerImage", fields: [bannerImageId], references: [id])
  Client                  User                 @relation("ClientOrders", fields: [clientId], references: [id])
  Category                Category?            @relation(fields: [categoryId], references: [id])
  Proposals               OrderProposal[]
  questions               OrderQuestion[]
  Reviews                 Review[]
  ChangeHistory           OrderChangeHistory[]
  SavedBy                 SavedOrder[]
  OrderSkills             OrderSkill[]
  Bookings                Booking[]
  Markets                 MarketOrder[]
  deletedAt               DateTime?

  @@index([status])
  @@index([orderType])
  @@index([deletedAt])
}

model OrderProposal {
  id                 Int            @id @default(autoincrement())
  orderId            Int
  userId             Int
  leadUserId         Int?
  teamId             Int?
  isGroupApplication Boolean        @default(false)
  price              Float?
  message            String?
  status             String         @default("pending")
  createdAt          DateTime       @default(now())
  Order              Order          @relation(fields: [orderId], references: [id])
  User               User           @relation(fields: [userId], references: [id])
  LeadUser           User?          @relation("LeadProposals", fields: [leadUserId], references: [id])
  Team               Team?          @relation(fields: [teamId], references: [id])
  ProposalPeers      ProposalPeer[]
}

model OrderQuestion {
  id        Int      @id @default(autoincrement())
  orderId   Int
  question  String
  order     Int      @default(0) // Order of the question (for sorting)
  createdAt DateTime @default(now())
  Order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model Review {
  id            Int            @id @default(autoincrement())
  orderId       Int
  reviewerId    Int
  specialistId  Int?
  rating        Int
  comment       String?
  createdAt     DateTime       @default(now())
  feedbackType  String         @default("completed")
  updatedAt     DateTime       @updatedAt
  Order         Order          @relation(fields: [orderId], references: [id])
  Reviewer      User           @relation("Reviewer", fields: [reviewerId], references: [id])
  Specialist    User?          @relation("Specialist", fields: [specialistId], references: [id])
  ReviewReasons ReviewReason[]

  @@index([feedbackType])
}

model MediaFile {
  id         Int      @id @default(autoincrement())
  orderId    Int?
  fileName   String
  fileUrl    String
  fileType   String
  mimeType   String
  fileSize   Int
  uploadedBy Int
  createdAt  DateTime @default(now())
  Order      Order?   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  User       User     @relation("MediaUploader", fields: [uploadedBy], references: [id])
  BannerFor  Order[]  @relation("BannerImage")
}

model Portfolio {
  id          Int      @id @default(autoincrement())
  userId      Int
  fileName    String
  fileUrl     String
  fileType    String
  mimeType    String
  fileSize    Int
  title       String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  User        User     @relation("Portfolio", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model TeamPortfolio {
  id          Int      @id @default(autoincrement())
  teamId      Int
  fileName    String
  fileUrl     String
  fileType    String
  mimeType    String
  fileSize    Int
  title       String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  Team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([createdAt])
}

model Card {
  id              Int      @id @default(autoincrement())
  userId          Int
  paymentMethodId String   @unique
  brand           String
  last4           String
  expMonth        Int
  expYear         Int
  holderName      String?
  isDefault       Boolean  @default(false)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([paymentMethodId])
}

model PhoneVerification {
  id            Int      @id @default(autoincrement())
  phoneHash     String   @unique @map("phone_hash") @db.VarChar(64)
  firstSignupAt DateTime @default(now()) @map("first_signup_at")
  lastSignupAt  DateTime @default(now()) @map("last_signup_at")
  signupCount   Int      @default(1) @map("signup_count")

  @@index([phoneHash])
  @@map("phone_verification")
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String
  title     String
  message   String
  isRead    Boolean  @default(false)
  data      Json?
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([type])
}

model Conversation {
  id           Int                       @id @default(autoincrement())
  orderId      Int?
  title        String?
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  status       String                    @default("active")
  Order        Order?                    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  Participants ConversationParticipant[]
  Messages     Message[]

  @@index([orderId])
  @@index([createdAt])
  @@index([status])
}

model ConversationParticipant {
  id             Int          @id @default(autoincrement())
  conversationId Int
  userId         Int
  joinedAt       DateTime     @default(now())
  lastReadAt     DateTime?
  isActive       Boolean      @default(true)
  Conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  User           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
}

model Message {
  id             Int          @id @default(autoincrement())
  conversationId Int
  senderId       Int
  content        String
  messageType    String       @default("text")
  metadata       Json?
  isEdited       Boolean      @default(false)
  editedAt       DateTime?
  createdAt      DateTime     @default(now())
  status         String       @default("active")
  Conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  Sender         User         @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@index([status])
}

model OrderPricing {
  id                   Int      @id @default(autoincrement())
  minBudget            Float
  maxBudget            Float?
  creditCost           Float // Percentage of order budget (e.g., 5.0 for 5%)
  teamCreditCost       Float? // Percentage for team applications (e.g., 7.0 for 7%)
  refundPercentage     Float    @default(0.5)
  teamRefundPercentage Float?   @default(0.5) // Separate refund percentage for team applications
  description          String?
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([minBudget])
  @@index([maxBudget])
  @@index([isActive])
}

model ReferralReward {
  id             Int       @id @default(autoincrement())
  referrerId     Int
  referredUserId Int
  rewardAmount   Float
  bonusAmount    Float     @default(0)
  status         String    @default("pending")
  createdAt      DateTime  @default(now())
  completedAt    DateTime?
  referredUser   User      @relation("ReferredUser", fields: [referredUserId], references: [id])
  referrer       User      @relation("ReferralRewards", fields: [referrerId], references: [id])

  @@index([referrerId])
  @@index([referredUserId])
  @@index([status])
}

model Reason {
  id            Int            @id @default(autoincrement())
  code          String         @unique
  nameEn        String
  nameRu        String
  nameHy        String
  descriptionEn String?
  descriptionRu String?
  descriptionHy String?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  ReviewReasons ReviewReason[]

  @@index([code])
  @@index([isActive])
}

model ReviewReason {
  id        Int      @id @default(autoincrement())
  reviewId  Int
  reasonId  Int
  createdAt DateTime @default(now())
  reason    Reason   @relation(fields: [reasonId], references: [id], onDelete: Cascade)
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@unique([reviewId, reasonId])
  @@index([reviewId])
  @@index([reasonId])
}

model CreditTransaction {
  id              Int      @id @default(autoincrement())
  userId          Int
  amount          Float
  balanceAfter    Float
  type            String
  status          String   @default("completed")
  description     String?
  referenceId     String?
  referenceType   String?
  metadata        Json?
  // Currency conversion fields
  currency        String? // User's currency (e.g., USD, EUR, RUB, AMD)
  baseCurrency    String?  @default("USD") // Base currency for credits (always USD)
  exchangeRate    Float? // Exchange rate used for conversion
  originalAmount  Float? // Amount in user's currency
  convertedAmount Float? // Amount in base currency (USD)
  createdAt       DateTime @default(now())
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model OrderChangeHistory {
  id           Int      @id @default(autoincrement())
  orderId      Int
  fieldChanged String // 'status', 'title', 'budget', etc.
  oldValue     String?
  newValue     String?
  changedBy    Int
  reason       String?
  createdAt    DateTime @default(now())
  Order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  ChangedBy    User     @relation("OrderChangedBy", fields: [changedBy], references: [id])

  @@index([orderId])
  @@index([createdAt])
  @@index([fieldChanged])
}

model SavedOrder {
  id        Int      @id @default(autoincrement())
  userId    Int
  orderId   Int
  createdAt DateTime @default(now())
  User      User     @relation("SavedOrders", fields: [userId], references: [id], onDelete: Cascade)
  Order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([userId, orderId])
  @@index([userId])
  @@index([orderId])
  @@index([createdAt])
}

model PeerRelationship {
  id        Int      @id @default(autoincrement())
  userId    Int
  peerId    Int
  status    String   @default("pending") // "pending", "accepted", "rejected"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isActive  Boolean  @default(true)
  User      User     @relation("PeerRelationships", fields: [userId], references: [id], onDelete: Cascade)
  Peer      User     @relation("PeerOf", fields: [peerId], references: [id], onDelete: Cascade)

  @@unique([userId, peerId])
  @@index([userId])
  @@index([peerId])
  @@index([status])
  @@index([isActive])
}

model Team {
  id          Int             @id @default(autoincrement())
  name        String
  description String?
  bannerUrl   String?
  createdBy   Int
  createdAt   DateTime        @default(now())
  isActive    Boolean         @default(true)
  Members     TeamMember[]
  Creator     User            @relation("TeamCreator", fields: [createdBy], references: [id])
  Proposals   OrderProposal[]
  Gallery     TeamPortfolio[]

  @@index([createdBy])
  @@index([isActive])
}

model TeamMember {
  id        Int      @id @default(autoincrement())
  teamId    Int
  userId    Int
  role      String   @default("member") // "lead" or "member"
  status    String   @default("pending") // "pending", "accepted", "rejected" (only for non-lead members)
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt
  isActive  Boolean  @default(true)
  Team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@index([status])
  @@index([isActive])
}

model ProposalPeer {
  id         Int           @id @default(autoincrement())
  proposalId Int
  userId     Int
  status     String        @default("pending") // "pending", "accepted", "rejected"
  joinedAt   DateTime      @default(now())
  Proposal   OrderProposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  User       User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([proposalId, userId])
  @@index([proposalId])
  @@index([userId])
  @@index([status])
}

model SystemConfig {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
}

model Skill {
  id            Int          @id @default(autoincrement())
  nameEn        String
  nameRu        String
  nameHy        String
  descriptionEn String?
  descriptionRu String?
  descriptionHy String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  OrderSkills   OrderSkill[]

  @@index([nameEn])
  @@index([nameRu])
  @@index([nameHy])
}

model OrderSkill {
  id        Int      @id @default(autoincrement())
  orderId   Int
  skillId   Int
  createdAt DateTime @default(now())
  Order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  Skill     Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([orderId, skillId])
  @@index([orderId])
  @@index([skillId])
}

model SubscriptionPlan {
  id                  Int                  @id @default(autoincrement())
  name                String
  nameEn              String?
  nameRu              String?
  nameHy              String?
  description         String?
  descriptionEn       String?
  descriptionRu       String?
  descriptionHy       String?
  price               Float
  currency            String               @default("AMD")
  durationDays        Int // Duration in days (30 for monthly, 365 for yearly)
  isRecurring         Boolean              @default(false) // Whether this plan supports auto-renewal
  features            Json? // Features included in this plan (e.g., unlimited applications, priority support)
  isActive            Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  Subscriptions       UserSubscription[]
  MarketSubscriptions MarketSubscription[]

  @@index([isActive])
  @@index([price])
}

model UserSubscription {
  id           Int                       @id @default(autoincrement())
  userId       Int
  planId       Int
  status       String                    @default("active") // "active", "expired", "cancelled"
  startDate    DateTime                  @default(now())
  endDate      DateTime
  autoRenew    Boolean                   @default(false)
  paymentId    String? // Payment ID from payment gateway
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  User         User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  Plan         SubscriptionPlan          @relation(fields: [planId], references: [id])
  Transactions SubscriptionTransaction[]

  @@index([userId])
  @@index([status])
  @@index([endDate])
  @@index([userId, status])
}

model SubscriptionTransaction {
  id             Int               @id @default(autoincrement())
  userId         Int
  subscriptionId Int? // Nullable until subscription is created
  amount         Float
  currency       String            @default("AMD")
  paymentId      String? // Payment ID from payment gateway
  status         String            @default("pending") // "pending", "completed", "failed"
  type           String            @default("initial") // "initial", "renewal"
  createdAt      DateTime          @default(now())
  User           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  Subscription   UserSubscription? @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([paymentId])
}

model Booking {
  id            Int      @id @default(autoincrement())
  orderId       Int
  clientId      Int
  scheduledDate String // Date string in ISO format
  startTime     String // Start time (HH:MM format)
  endTime       String // End time (HH:MM format)
  status        String   @default("confirmed") // pending, confirmed, completed, cancelled
  marketMemberId Int? // Market member (specialist) assigned to this booking (for select mode)
  clientMessage  String? // Optional message from client when creating the booking
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  Order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  Client        User     @relation("ClientBookings", fields: [clientId], references: [id])
  MarketMember  MarketMember? @relation(fields: [marketMemberId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([clientId])
  @@index([scheduledDate])
  @@index([status])
  @@index([marketMemberId])
}

model Market {
  id              Int                  @id @default(autoincrement())
  name            String
  nameEn          String?
  nameRu          String?
  nameHy          String?
  description     String?
  descriptionEn   String?
  descriptionRu   String?
  descriptionHy   String?
  location        String?
  status          String               @default("draft") // draft, pending_review, active, closed, rejected
  verified        Boolean              @default(false)
  bannerImageId   Int? // References MarketMediaFile.id
  weeklySchedule  Json? // Recurring weekly schedule for business hours (when service is open/closed)
  createdBy       Int
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  joinDate        DateTime             @default(now())
  rejectionReason String?
  Creator         User                 @relation("MarketCreator", fields: [createdBy], references: [id])
  BannerImage     MarketMediaFile?     @relation("MarketBannerImage", fields: [bannerImageId], references: [id])
  Members         MarketMember[]
  Orders          MarketOrder[]
  Reviews         MarketReview[]
  MediaFiles      MarketMediaFile[]
  Roles           MarketRole[]
  Subscriptions   MarketSubscription[]

  @@index([status])
  @@index([createdBy])
  @@index([verified])
  @@index([location])
}

model MarketMember {
  id        Int      @id @default(autoincrement())
  marketId  Int
  userId    Int
  role      String   @default("member") // References MarketRole or custom role name
  status    String   @default("pending") // pending, accepted, rejected
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt
  isActive  Boolean  @default(true)
  Market    Market   @relation(fields: [marketId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Bookings  Booking[] // Bookings assigned to this market member

  @@unique([marketId, userId])
  @@index([marketId])
  @@index([userId])
  @@index([status])
  @@index([isActive])
}

model MarketRole {
  id          Int      @id @default(autoincrement())
  marketId    Int?
  name        String
  nameEn      String?
  nameRu      String?
  nameHy      String?
  permissions Json? // Role permissions stored as JSON
  isDefault   Boolean  @default(false) // true for global default roles
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  Market      Market?  @relation(fields: [marketId], references: [id], onDelete: Cascade)

  @@index([marketId])
  @@index([isDefault])
}

model MarketReview {
  id         Int      @id @default(autoincrement())
  marketId   Int
  reviewerId Int
  rating     Int // 1-5
  comment    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  Market     Market   @relation(fields: [marketId], references: [id], onDelete: Cascade)
  Reviewer   User     @relation(fields: [reviewerId], references: [id], onDelete: Cascade)

  @@index([marketId])
  @@index([reviewerId])
  @@index([rating])
}

model MarketOrder {
  id       Int      @id @default(autoincrement())
  marketId Int
  orderId  Int
  addedAt  DateTime @default(now())
  Market   Market   @relation(fields: [marketId], references: [id], onDelete: Cascade)
  Order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([marketId, orderId])
  @@index([marketId])
  @@index([orderId])
}

model MarketMediaFile {
  id         Int      @id @default(autoincrement())
  marketId   Int
  fileName   String
  fileUrl    String
  fileType   String
  mimeType   String
  fileSize   Int
  uploadedBy Int
  createdAt  DateTime @default(now())
  Market     Market   @relation(fields: [marketId], references: [id], onDelete: Cascade)
  User       User     @relation("MarketMediaUploader", fields: [uploadedBy], references: [id])
  BannerFor  Market[] @relation("MarketBannerImage")

  @@index([marketId])
  @@index([uploadedBy])
  @@index([createdAt])
}

model MarketSubscription {
  id                 Int              @id @default(autoincrement())
  marketId           Int
  subscriptionPlanId Int
  userId             Int
  status             String           @default("active") // active, expired, cancelled
  startDate          DateTime         @default(now())
  endDate            DateTime
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  Market             Market           @relation(fields: [marketId], references: [id], onDelete: Cascade)
  SubscriptionPlan   SubscriptionPlan @relation(fields: [subscriptionPlanId], references: [id])
  User               User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([marketId])
  @@index([userId])
  @@index([status])
  @@index([endDate])
  @@index([marketId, status])
}
